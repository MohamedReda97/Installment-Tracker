<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Installments Timeline</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Data labels plugin -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color-scheme: dark light;
    }
    body {
      margin: 0;
      padding: 1.5rem;
      background: #111827;
      color: #e5e7eb;
    }
    h1, h2 {
      margin-top: 0;
      color: #f9fafb;
    }
    .card {
      background: #1f2933;
      border-radius: 12px;
      padding: 1rem 1.25rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 10px 30px rgba(0,0,0,0.4);
    }
    label {
      display: inline-block;
      margin-bottom: 0.25rem;
      font-size: 0.9rem;
      color: #9ca3af;
    }
    input, button {
      font-family: inherit;
    }
    input[type="month"],
    input[type="number"],
    input[type="text"] {
      background: #111827;
      color: #e5e7eb;
      border: 1px solid #374151;
      border-radius: 8px;
      padding: 0.35rem 0.5rem;
      font-size: 0.9rem;
    }
    input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 1px #3b82f6;
    }
    button {
      border-radius: 999px;
      border: none;
      cursor: pointer;
      padding: 0.45rem 0.9rem;
      font-size: 0.9rem;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.15s ease;
    }
    button.primary {
      background: linear-gradient(135deg, #2563eb, #4f46e5);
      color: white;
      box-shadow: 0 8px 20px rgba(37,99,235,0.35);
    }
    button.primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 25px rgba(37,99,235,0.45);
    }
    button.secondary {
      background: #111827;
      color: #e5e7eb;
      border: 1px solid #374151;
    }
    button.secondary:hover {
      background: #1f2937;
    }
    button.danger {
      background: #b91c1c;
      color: white;
    }
    button.danger:hover {
      background: #dc2626;
    }
    .toolbar {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }
    thead {
      background: #111827;
    }
    th, td {
      border-bottom: 1px solid #374151;
      padding: 0.4rem 0.3rem;
      text-align: left;
      white-space: nowrap;
      vertical-align: middle; /* ØªÙˆØ³ÙŠØ· Ø¹Ù…ÙˆØ¯ÙŠ Ù„ÙƒÙ„ Ø§Ù„Ø®Ù„Ø§ÙŠØ§ */
    }
    th {
      font-weight: 600;
      color: #9ca3af;
    }
    tbody tr:hover {
      background: rgba(55, 65, 81, 0.55);
    }
    td input {
      width: 100%;
      box-sizing: border-box;
    }
    /* Ø´ÙƒÙ„ Ø£ÙØ¶Ù„ Ù„Ø¹Ù…ÙˆØ¯ Remaining */
    .pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.2rem 0.6rem;
      border-radius: 999px;
      background: rgba(55,65,81,0.95);
      font-size: 0.8rem;
      color: #f9fafb;
      min-width: 3rem;
      height: 1.6rem;
    }
    #timelineSummaryTable {
      margin-top: 1rem;
      border-collapse: collapse;
      width: 100%;
      font-size: 0.85rem;
    }
    #timelineSummaryTable th,
    #timelineSummaryTable td {
      border-bottom: 1px solid #374151;
      padding: 0.3rem 0.4rem;
      text-align: left;
    }
    #timelineSummaryTable th {
      color: #9ca3af;
    }
    .small-hint {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-top: 0.25rem;
    }
    @media (max-width: 768px) {
      table, #timelineSummaryTable {
        font-size: 0.75rem;
      }
      body {
        padding: 0.8rem;
      }
    }
  </style>
</head>
<body>
  <h1>Installments Timeline</h1>

  <div class="card">
    <div class="toolbar">
      <div>
        <label for="billingMonth">Billing month (statement month)</label><br />
        <input id="billingMonth" type="month" />
        <div class="small-hint">
          ÙŠØ¨Ø¯Ø£ Ù…Ù† Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù„ÙŠ Ø¨Ø¹Ø¯Ù‡. Ù…Ø«Ø§Ù„: ÙƒØ´Ù Ø£ÙƒØªÙˆØ¨Ø± â†’ Ø§Ø®ØªØ± <strong>2025-10</strong>.
        </div>
      </div>
      <div style="flex: 1 1 auto;"></div>
      <div style="display:flex; gap:0.5rem; flex-wrap:wrap;">
        <button class="secondary" id="decAllBtn" type="button">-1 All</button>
        <button class="secondary" id="incAllBtn" type="button">+1 All</button>
        <button class="secondary" id="addRowBtn" type="button">ï¼‹ Add row</button>
        <button class="secondary" id="saveDataBtn" type="button">ğŸ’¾ Save Data</button>
      </div>
    </div>

    <table id="installmentsTable">
      <thead>
        <tr>
          <th>Merchant</th>
          <th>Monthly Amount (Total)</th>
          <th>Current Installment No.</th>
          <th>Total Installments (Out of)</th>
          <th>Remaining</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <!-- Default rows â€“ Ù…Ù…ÙƒÙ† ØªØªØ¹Ø¯Ù„ ÙˆÙ‡ØªØªØ­ÙØ¸ ÙÙŠ localStorage -->
        <tr>
          <td><input type="text" value="NOON 511.60" /></td>
          <td><input type="number" step="0.01" value="511.60" /></td>
          <td><input type="number" value="12" /></td>
          <td><input type="number" value="15" /></td>
          <td class="remaining-cell pill"></td>
          <td><button class="danger" type="button" onclick="deleteRow(this)">Delete</button></td>
        </tr>
        <tr>
          <td><input type="text" value="NOON 183.95" /></td>
          <td><input type="number" step="0.01" value="183.95" /></td>
          <td><input type="number" value="12" /></td>
          <td><input type="number" value="15" /></td>
          <td class="remaining-cell pill"></td>
          <td><button class="danger" type="button" onclick="deleteRow(this)">Delete</button></td>
        </tr>
        <tr>
          <td><input type="text" value="Amazon 387.16" /></td>
          <td><input type="number" step="0.01" value="387.16" /></td>
          <td><input type="number" value="12" /></td>
          <td><input type="number" value="18" /></td>
          <td class="remaining-cell pill"></td>
          <td><button class="danger" type="button" onclick="deleteRow(this)">Delete</button></td>
        </tr>
        <tr>
          <td><input type="text" value="Amazon 1474.94" /></td>
          <td><input type="number" step="0.01" value="1474.94" /></td>
          <td><input type="number" value="9" /></td>
          <td><input type="number" value="12" /></td>
          <td class="remaining-cell pill"></td>
          <td><button class="danger" type="button" onclick="deleteRow(this)">Delete</button></td>
        </tr>
        <tr>
          <td><input type="text" value="NOON 186.77" /></td>
          <td><input type="number" step="0.01" value="186.77" /></td>
          <td><input type="number" value="11" /></td>
          <td><input type="number" value="15" /></td>
          <td class="remaining-cell pill"></td>
          <td><button class="danger" type="button" onclick="deleteRow(this)">Delete</button></td>
        </tr>
        <tr>
          <td><input type="text" value="NOON 634.90" /></td>
          <td><input type="number" step="0.01" value="634.90" /></td>
          <td><input type="number" value="9" /></td>
          <td><input type="number" value="18" /></td>
          <td class="remaining-cell pill"></td>
          <td><button class="danger" type="button" onclick="deleteRow(this)">Delete</button></td>
        </tr>
        <tr>
          <td><input type="text" value="NOON 236.59" /></td>
          <td><input type="number" step="0.01" value="236.59" /></td>
          <td><input type="number" value="9" /></td>
          <td><input type="number" value="18" /></td>
          <td class="remaining-cell pill"></td>
          <td><button class="danger" type="button" onclick="deleteRow(this)">Delete</button></td>
        </tr>
        <tr>
          <td><input type="text" value="NOON 109.63" /></td>
          <td><input type="number" step="0.01" value="109.63" /></td>
          <td><input type="number" value="9" /></td>
          <td><input type="number" value="18" /></td>
          <td class="remaining-cell pill"></td>
          <td><button class="danger" type="button" onclick="deleteRow(this)">Delete</button></td>
        </tr>
      </tbody>
    </table>

    <div style="margin-top: 1rem; display: flex; gap: 0.75rem; align-items: center; flex-wrap:wrap;">
      <button class="primary" id="calculateBtn" type="button">âš™ï¸ Calculate Timeline</button>
      <span class="small-hint">
        Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙƒÙ…Ø§ ØªØ±ÙŠØ¯ØŒ Ø§Ø³ØªØ®Ø¯Ù… +1/-1 Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙƒÙ„ Ø´Ù‡Ø±ØŒ Ø«Ù… Ø§Ø¶ØºØ· <strong>Calculate Timeline</strong>.  
        Ø§Ø³ØªØ®Ø¯Ù… <strong>Save Data</strong> Ù„Ø­ÙØ¸ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙˆØ§Ù„Ù€ Billing month ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­.
      </span>
    </div>
  </div>

  <div class="card">
    <h2>Monthly Payments Timeline</h2>
    <canvas id="timelineChart" height="120"></canvas>
    <table id="timelineSummaryTable">
      <thead>
        <tr>
          <th>Month</th>
          <th>Total Payment</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const STORAGE_KEY = 'installmentsTableData_v2';

    function addMonthsToDate(dateObj, months) {
      const d = new Date(dateObj.getTime());
      d.setDate(1);
      d.setMonth(d.getMonth() + months);
      return d;
    }

    function formatMonthLabel(dateObj) {
      return dateObj.toLocaleDateString(undefined, { year: 'numeric', month: 'short' });
    }

    function deleteRow(btn) {
      const row = btn.closest('tr');
      if (row) row.remove();
    }

    function addRow(data) {
      const tbody = document.querySelector('#installmentsTable tbody');
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input type="text" placeholder="Merchant" /></td>
        <td><input type="number" step="0.01" placeholder="Amount" /></td>
        <td><input type="number" placeholder="Current" /></td>
        <td><input type="number" placeholder="Total" /></td>
        <td class="remaining-cell pill"></td>
        <td><button class="danger" type="button" onclick="deleteRow(this)">Delete</button></td>
      `;
      tbody.appendChild(tr);

      if (data) {
        const inputs = tr.querySelectorAll('input');
        inputs[0].value = data.merchant || '';
        inputs[1].value = data.amount || '';
        inputs[2].value = data.current || '';
        inputs[3].value = data.total || '';
      }
    }

    document.getElementById('addRowBtn').addEventListener('click', () => addRow());

    function recalcRemainingForRow(row) {
      const cells = row.querySelectorAll('td');
      if (cells.length < 5) return;
      const currentInput = cells[2].querySelector('input');
      const totalInput = cells[3].querySelector('input');
      const remainingCell = cells[4];

      const currentInst = parseInt(currentInput.value, 10);
      const totalInst = parseInt(totalInput.value, 10);

      if (isNaN(currentInst) || isNaN(totalInst) || totalInst <= 0) {
        remainingCell.textContent = '';
        return;
      }

      const remaining = Math.max(0, totalInst - currentInst);
      remainingCell.textContent = remaining.toString();
    }

    function recalcAllRemaining() {
      const rows = document.querySelectorAll('#installmentsTable tbody tr');
      rows.forEach(recalcRemainingForRow);
    }

    function incDecAll(delta) {
      const rows = document.querySelectorAll('#installmentsTable tbody tr');
      rows.forEach((row) => {
        const cells = row.querySelectorAll('td');
        if (cells.length < 4) return;
        const currentInput = cells[2].querySelector('input');
        const totalInput = cells[3].querySelector('input');
        let currentInst = parseInt(currentInput.value, 10);
        const totalInst = parseInt(totalInput.value, 10);

        if (isNaN(currentInst)) currentInst = 0;
        let newVal = currentInst + delta;
        if (newVal < 0) newVal = 0;
        if (!isNaN(totalInst) && totalInst > 0 && newVal > totalInst) newVal = totalInst;

        currentInput.value = newVal.toString();
      });
      recalcAllRemaining();
    }

    document.getElementById('incAllBtn').addEventListener('click', () => incDecAll(1));
    document.getElementById('decAllBtn').addEventListener('click', () => incDecAll(-1));

    // ---- localStorage (table + billingMonth) ----

    function readTableData() {
      const rows = document.querySelectorAll('#installmentsTable tbody tr');
      const data = [];
      rows.forEach((row) => {
        const inputs = row.querySelectorAll('input');
        if (inputs.length < 4) return;
        const merchant = inputs[0].value.trim();
        const amount = inputs[1].value.trim();
        const current = inputs[2].value.trim();
        const total = inputs[3].value.trim();
        if (!merchant && !amount && !current && !total) return;
        data.push({ merchant, amount, current, total });
      });
      return data;
    }

    function writeTableData(dataArray) {
      const tbody = document.querySelector('#installmentsTable tbody');
      tbody.innerHTML = '';
      dataArray.forEach((row) => addRow(row));
      recalcAllRemaining();
    }

    function saveTableToStorage() {
      try {
        const rowsData = readTableData();
        const billingMonth = document.getElementById('billingMonth').value || null;
        const payload = { billingMonth, rows: rowsData };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
        alert('Data saved locally âœ”');
      } catch (err) {
        console.error('Error saving data:', err);
        alert('Error saving data (check console).');
      }
    }

    function loadTableFromStorage() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) {
          recalcAllRemaining();
          return;
        }
        const payload = JSON.parse(raw);

        // backward compatibility Ù„Ùˆ ÙƒØ§Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù‚Ø¯ÙŠÙ… Ù…Ø¬Ø±Ø¯ Array
        if (Array.isArray(payload)) {
          writeTableData(payload);
          return;
        }

        if (payload && Array.isArray(payload.rows)) {
          writeTableData(payload.rows);
        }
        if (payload && payload.billingMonth) {
          document.getElementById('billingMonth').value = payload.billingMonth;
        }
      } catch (err) {
        console.error('Error loading data:', err);
        recalcAllRemaining();
      }
    }

    document.getElementById('saveDataBtn').addEventListener('click', saveTableToStorage);

    // ---- Timeline + Chart ----

    let timelineChart = null;

    function calculateTimeline() {
      const billingMonthValue = document.getElementById('billingMonth').value;
      if (!billingMonthValue) {
        alert('Please select the billing month (statement month).');
        return;
      }
      const billingDate = new Date(billingMonthValue + '-01T00:00:00');

      const tbody = document.querySelector('#installmentsTable tbody');
      const rows = Array.from(tbody.querySelectorAll('tr'));

      const monthIndexTotals = {};
      let maxIndex = 0;

      rows.forEach((row) => {
        const cells = row.querySelectorAll('td');
        if (cells.length < 5) return;

        const amountInput = cells[1].querySelector('input');
        const currentInput = cells[2].querySelector('input');
        const totalInput = cells[3].querySelector('input');
        const remainingCell = cells[4];

        const amount = parseFloat(amountInput.value);
        const currentInst = parseInt(currentInput.value, 10);
        const totalInst = parseInt(totalInput.value, 10);

        if (isNaN(amount) || isNaN(currentInst) || isNaN(totalInst) || totalInst <= 0) {
          remainingCell.textContent = '';
          return;
        }

        const remaining = Math.max(0, totalInst - currentInst);
        remainingCell.textContent = remaining.toString();

        if (remaining <= 0) return;

        for (let i = 1; i <= remaining; i++) {
          monthIndexTotals[i] = (monthIndexTotals[i] || 0) + amount;
          if (i > maxIndex) maxIndex = i;
        }
      });

      if (maxIndex === 0) {
        alert('No remaining installments found.');
        updateChart([], []);
        updateTimelineTable([]);
        return;
      }

      const labels = [];
      const data = [];
      const timelinePairs = [];

      for (let i = 1; i <= maxIndex; i++) {
        const monthDate = addMonthsToDate(billingDate, i);
        const total = monthIndexTotals[i] || 0;
        labels.push(formatMonthLabel(monthDate));
        data.push(Number(total.toFixed(2)));
        timelinePairs.push({ date: monthDate, total: total });
      }

      updateChart(labels, data);
      updateTimelineTable(timelinePairs);
    }

    function updateChart(labels, data) {
      const ctx = document.getElementById('timelineChart').getContext('2d');

      if (timelineChart) {
        timelineChart.data.labels = labels;
        timelineChart.data.datasets[0].data = data;
        timelineChart.update();
        return;
      }

      timelineChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Total payment per month',
            data: data
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              labels: {
                color: '#e5e7eb'
              }
            },
            datalabels: {
              anchor: 'end',
              align: 'end',
              color: '#e5e7eb',
              font: {
                weight: 'bold',
                size: 10
              },
              formatter: (value) => value.toFixed(2)
            }
          },
          scales: {
            x: {
              ticks: { color: '#e5e7eb' },
              grid: { color: '#374151' }
            },
            y: {
              ticks: { color: '#e5e7eb' },
              grid: { color: '#374151' }
            }
          }
        },
        plugins: [ChartDataLabels]
      });
    }

    function updateTimelineTable(timelinePairs) {
      const tbody = document.querySelector('#timelineSummaryTable tbody');
      tbody.innerHTML = '';

      timelinePairs.forEach((item) => {
        const tr = document.createElement('tr');
        const monthStr = formatMonthLabel(item.date);
        const tdMonth = document.createElement('td');
        const tdTotal = document.createElement('td');
        tdMonth.textContent = monthStr;
        tdTotal.textContent = item.total.toFixed(2);
        tr.appendChild(tdMonth);
        tr.appendChild(tdTotal);
        tbody.appendChild(tr);
      });
    }

    document.getElementById('calculateBtn').addEventListener('click', calculateTimeline);

    // init: set default billing month (Ù„Ùˆ Ù…ÙÙŠØ´ ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ†) + ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    (function init() {
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      document.getElementById('billingMonth').value = `${year}-${month}`;
      loadTableFromStorage();
      recalcAllRemaining();
    })();
  </script>
</body>
</html>
