<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Installments Timeline</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Data labels plugin -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color-scheme: dark light;
    }
    body {
      margin: 0;
      padding: 1.5rem;
      background: #111827;
      color: #e5e7eb;
    }
    h1, h2 {
      margin-top: 0;
      color: #f9fafb;
    }
    .card {
      background: #1f2933;
      border-radius: 12px;
      padding: 1rem 1.25rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 10px 30px rgba(0,0,0,0.4);
    }
    label {
      display: inline-block;
      margin-bottom: 0.25rem;
      font-size: 0.9rem;
      color: #9ca3af;
    }
    input, button {
      font-family: inherit;
    }
    input[type="month"],
    input[type="number"],
    input[type="text"],
    input[type="date"] {
      background: #111827;
      color: #e5e7eb;
      border: 1px solid #374151;
      border-radius: 8px;
      padding: 0.35rem 0.5rem;
      font-size: 0.9rem;
    }

    /* Style for date inputs to show dd/mm/yyyy format */
    input[type="date"]::-webkit-datetime-edit,
    input[type="date"]::-webkit-inner-spin-button,
    input[type="date"]::-webkit-clear-button {
      display: none;
    }

    input[type="date"]::-webkit-calendar-picker-indicator {
      position: absolute;
      right: 0.5rem;
      color: #e5e7eb;
      opacity: 0.7;
    }

    input[type="date"]::before {
      content: attr(data-date);
      color: #e5e7eb;
    }

    input[type="date"]:focus::before,
    input[type="date"]:valid::before {
      content: attr(data-date);
    }
    input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 1px #3b82f6;
    }
    button {
      border-radius: 999px;
      border: none;
      cursor: pointer;
      padding: 0.45rem 0.9rem;
      font-size: 0.9rem;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.15s ease;
    }
    button.primary {
      background: linear-gradient(135deg, #2563eb, #4f46e5);
      color: white;
      box-shadow: 0 8px 20px rgba(37,99,235,0.35);
    }
    button.primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 25px rgba(37,99,235,0.45);
    }
    button.secondary {
      background: #111827;
      color: #e5e7eb;
      border: 1px solid #374151;
    }
    button.secondary:hover {
      background: #1f2937;
    }
    button.danger {
      background: #b91c1c;
      color: white;
    }
    button.danger:hover {
      background: #dc2626;
    }
    .toolbar {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }
    thead {
      background: #111827;
    }
    th, td {
      border-bottom: 1px solid #374151;
      padding: 0.4rem 0.3rem;
      text-align: left;
      white-space: nowrap;
      vertical-align: middle;
    }
    th {
      font-weight: 600;
      color: #9ca3af;
    }
    th.sortable {
      cursor: pointer;
      user-select: none;
      position: relative;
      padding-right: 1.2rem;
    }
    th.sortable:hover {
      color: #e5e7eb;
    }
    th.sortable::after {
      content: '‚áÖ';
      position: absolute;
      right: 0.3rem;
      opacity: 0.4;
    }
    th.sortable.asc::after {
      content: '‚ñ≤';
      opacity: 1;
    }
    th.sortable.desc::after {
      content: '‚ñº';
      opacity: 1;
    }
    tbody tr:hover {
      background: rgba(55, 65, 81, 0.55);
    }
    td input {
      width: 100%;
      box-sizing: border-box;
    }
    #monthDetailTable {
      margin-top: 0.5rem;
      border-collapse: collapse;
      width: 100%;
      font-size: 0.85rem;
    }
    #monthDetailTable th,
    #monthDetailTable td {
      border-bottom: 1px solid #374151;
      padding: 0.3rem 0.4rem;
      text-align: left;
    }
    #monthDetailTable th {
      color: #9ca3af;
    }
    #monthDetailTable tbody tr:hover {
      background: rgba(55, 65, 81, 0.55);
    }
    .small-hint {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-top: 0.25rem;
    }
    .month-controls {
      display: inline-flex;
      gap: 0.25rem;
      margin-left: 0.5rem;
      vertical-align: middle;
    }
    .month-controls button {
      padding: 0.25rem 0.5rem;
      font-size: 0.85rem;
      min-width: 32px;
    }
    @media (max-width: 768px) {
      table, #timelineSummaryTable {
        font-size: 0.75rem;
      }
      body {
        padding: 0.8rem;
      }
    }
  </style>
</head>
<body>
  <h1>Installments Timeline</h1>

  <div class="card">
    <div class="toolbar">
      <div>
        <label for="billingMonth">Billing month (statement month)</label><br />
        <input id="billingMonth" type="month" />
        <div class="month-controls">
          <button class="secondary" id="decreaseMonthBtn" type="button" title="Previous month">‚óÄ</button>
          <button class="secondary" id="increaseMonthBtn" type="button" title="Next month">‚ñ∂</button>
        </div>
        <div class="small-hint">
          Ÿäÿ®ÿØÿ£ ÿßŸÑÿ≠ÿ≥ÿßÿ® ŸÖŸÜ ÿßŸÑÿ¥Ÿáÿ± ÿßŸÑŸÑŸä ÿ®ÿπÿØŸá. ŸÖÿ´ÿßŸÑ: ŸÉÿ¥ŸÅ ÿ£ŸÉÿ™Ÿàÿ®ÿ± ‚Üí ÿßÿÆÿ™ÿ± <strong>2025-10</strong>.
        </div>
      </div>
      <div style="flex: 1 1 auto;"></div>
      <div style="display:flex; gap:0.5rem; flex-wrap:wrap;">
        <button class="secondary" id="addRowBtn" type="button">Ôºã Add row</button>
        <button class="secondary" id="saveDataBtn" type="button">üíæ Save Data</button>
      </div>
    </div>

    <table id="installmentsTable">
      <thead>
        <tr>
          <th>Merchant</th>
          <th class="sortable" data-column="enrollmentDate">Enrollment Date</th>
          <th class="sortable" data-column="amount">Monthly Amount (Total)</th>
          <th>Total Installments (Out of)</th>
          <th>First Installment</th>
          <th class="sortable" data-column="currentInstallment">Current Installment No.</th>
          <th>Remaining</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <!-- Sample data based on the screenshot (year assumed 2024/2025) -->
        <tr>
          <td><input type="text" value="NOON 511.60" /></td>
          <td><input type="date" class="auto-recalc" value="2024-11-09" /></td>
          <td><input type="number" step="0.01" value="511.60" /></td>
          <td><input type="number" class="auto-recalc" value="15" /></td>
          <td></td><td></td><td></td>
          <td><button class="danger" type="button" onclick="deleteRow(this)">Delete</button></td>
        </tr>
        <tr>
          <td><input type="text" value="NOON 183.95" /></td>
          <td><input type="date" class="auto-recalc" value="2024-11-09" /></td>
          <td><input type="number" step="0.01" value="183.95" /></td>
          <td><input type="number" class="auto-recalc" value="15" /></td>
          <td></td><td></td><td></td>
          <td><button class="danger" type="button" onclick="deleteRow(this)">Delete</button></td>
        </tr>
        <tr>
          <td><input type="text" value="Amazon 387.16" /></td>
          <td><input type="date" class="auto-recalc" value="2024-11-17" /></td>
          <td><input type="number" step="0.01" value="387.16" /></td>
          <td><input type="number" class="auto-recalc" value="18" /></td>
          <td></td><td></td><td></td>
          <td><button class="danger" type="button" onclick="deleteRow(this)">Delete</button></td>
        </tr>
        <tr>
          <td><input type="text" value="NOON 186.77" /></td>
          <td><input type="date" class="auto-recalc" value="2024-11-25" /></td>
          <td><input type="number" step="0.01" value="186.77" /></td>
          <td><input type="number" class="auto-recalc" value="15" /></td>
          <td></td><td></td><td></td>
          <td><button class="danger" type="button" onclick="deleteRow(this)">Delete</button></td>
        </tr>
        <tr>
          <td><input type="text" value="Amazon 1474.94" /></td>
          <td><input type="date" class="auto-recalc" value="2025-02-17" /></td>
          <td><input type="number" step="0.01" value="1474.94" /></td>
          <td><input type="number" class="auto-recalc" value="12" /></td>
          <td></td><td></td><td></td>
          <td><button class="danger" type="button" onclick="deleteRow(this)">Delete</button></td>
        </tr>
        <tr>
          <td><input type="text" value="NOON 634.90" /></td>
          <td><input type="date" class="auto-recalc" value="2025-10-01" /></td>
          <td><input type="number" step="0.01" value="634.90" /></td>
          <td><input type="number" class="auto-recalc" value="10" /></td>
          <td></td><td></td><td></td>
          <td><button class="danger" type="button" onclick="deleteRow(this)">Delete</button></td>
        </tr>
        <tr>
          <td><input type="text" value="NOON 236.59" /></td>
          <td><input type="date" class="auto-recalc" value="2025-10-02" /></td>
          <td><input type="number" step="0.01" value="236.59" /></td>
          <td><input type="number" class="auto-recalc" value="10" /></td>
          <td></td><td></td><td></td>
          <td><button class="danger" type="button" onclick="deleteRow(this)">Delete</button></td>
        </tr>
        <tr>
          <td><input type="text" value="NOON 109.63" /></td>
          <td><input type="date" class="auto-recalc" value="2025-10-04" /></td>
          <td><input type="number" step="0.01" value="109.63" /></td>
          <td><input type="number" class="auto-recalc" value="10" /></td>
          <td></td><td></td><td></td>
          <td><button class="danger" type="button" onclick="deleteRow(this)">Delete</button></td>
        </tr>
      </tbody>
    </table>

    <div style="margin-top: 1rem; display: flex; gap: 0.75rem; align-items: center; flex-wrap:wrap;">
      <button class="primary" id="calculateBtn" type="button">‚öôÔ∏è Calculate Timeline</button>
      <span class="small-hint">
        ÿ£ÿØÿÆŸÑ / ÿπÿØŸëŸÑ Enrollment Date, Amount, Total Installmentsÿå ÿ´ŸÖ ÿßÿ∂ÿ∫ÿ∑ <strong>Calculate Timeline</strong>.  
        ÿßÿ≥ÿ™ÿÆÿØŸÖ <strong>Save Data</strong> ŸÑÿ≠ŸÅÿ∏ ÿßŸÑÿ¨ÿØŸàŸÑ ŸÅŸä ÿßŸÑŸÖÿ™ÿµŸÅÿ≠ (ÿ®ÿØŸàŸÜ ÿ≠ŸÅÿ∏ ÿßŸÑŸÄ Billing month).
      </span>
    </div>
  </div>

  <div class="card">
    <h2>Monthly Payments Timeline</h2>
    <div class="small-hint" style="margin-bottom: 0.5rem;">
      Click on any bar to see installment details for that month.
    </div>
    <canvas id="timelineChart" height="120"></canvas>
    <div id="monthDetailSection" style="display: none; margin-top: 1.5rem;">
      <h3 id="monthDetailTitle" style="color: #f9fafb; margin-bottom: 0.5rem;"></h3>
      <table id="monthDetailTable">
        <thead>
          <tr>
            <th>Merchant</th>
            <th>Installment No.</th>
            <th>Amount</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    const STORAGE_KEY = 'installmentsTableData_v5';

    function addMonthsToDate(dateObj, months) {
      const d = new Date(dateObj.getTime());
      d.setDate(1);
      d.setMonth(d.getMonth() + months);
      return d;
    }

    function formatMonthLabel(dateObj) {
      return dateObj.toLocaleDateString(undefined, { year: 'numeric', month: 'short' });
    }

    function formatDateYMD(d) {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${y}-${m}-${day}`;
    }

    function formatDateDMY(d) {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${day}/${m}/${y}`;
    }

    function ymdToDMY(ymdStr) {
      if (!ymdStr) return '';
      const parts = ymdStr.split('-');
      if (parts.length !== 3) return ymdStr;
      return `${parts[2]}/${parts[1]}/${parts[0]}`;
    }

    function dmyToYMD(dmyStr) {
      if (!dmyStr) return '';
      const parts = dmyStr.split('/');
      if (parts.length !== 3) return dmyStr;
      return `${parts[2]}-${parts[1]}-${parts[0]}`;
    }

    // Update date input to show dd/mm/yyyy format using title attribute
    function setupDateInput(input) {
      input.addEventListener('change', function() {
        if (this.value) {
          this.setAttribute('data-date', ymdToDMY(this.value));
          this.style.setProperty('--date-display', `"${ymdToDMY(this.value)}"`);
        }
      });

      // Set initial display if value exists
      if (input.value) {
        input.setAttribute('data-date', ymdToDMY(input.value));
        input.style.setProperty('--date-display', `"${ymdToDMY(input.value)}"`);
      }
    }

    function deleteRow(btn) {
      const row = btn.closest('tr');
      if (row) row.remove();
    }

    function addRow(data) {
      const tbody = document.querySelector('#installmentsTable tbody');
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input type="text" placeholder="Merchant" /></td>
        <td><input type="date" class="auto-recalc" /></td>
        <td><input type="number" step="0.01" placeholder="Amount" /></td>
        <td><input type="number" placeholder="Total" class="auto-recalc" /></td>
        <td></td><td></td><td></td>
        <td><button class="danger" type="button" onclick="deleteRow(this)">Delete</button></td>
      `;
      tbody.appendChild(tr);

      const dateInput = tr.querySelectorAll('input')[1];
      setupDateInput(dateInput);

      if (data) {
        const inputs = tr.querySelectorAll('input');
        inputs[0].value = data.merchant || '';
        inputs[1].value = data.enrollmentDate || '';
        inputs[2].value = data.amount || '';
        inputs[3].value = data.total || '';

        // Update date display
        if (data.enrollmentDate) {
          dateInput.setAttribute('data-date', ymdToDMY(data.enrollmentDate));
        }
      }

      // Add event listeners for auto-recalculation
      const autoRecalcInputs = tr.querySelectorAll('.auto-recalc');
      autoRecalcInputs.forEach(input => {
        input.addEventListener('change', triggerRecalculation);
      });
    }

    document.getElementById('addRowBtn').addEventListener('click', () => addRow());

    // Trigger recalculation when enrollment date or total installments change
    function triggerRecalculation() {
      const val = document.getElementById('billingMonth').value;
      if (!val) return;
      const billingDate = new Date(val + '-01T00:00:00');
      recomputeRowsAndCollectTimeline(billingDate, false);
    }

    // ---- Sorting functionality ----
    let currentSortColumn = null;
    let currentSortDirection = 'asc';

    function sortTable(column) {
      const tbody = document.querySelector('#installmentsTable tbody');
      const rows = Array.from(tbody.querySelectorAll('tr'));

      // Toggle sort direction if clicking the same column
      if (currentSortColumn === column) {
        currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
      } else {
        currentSortColumn = column;
        currentSortDirection = 'asc';
      }

      // Sort rows based on column
      rows.sort((rowA, rowB) => {
        let valA, valB;

        if (column === 'enrollmentDate') {
          const inputA = rowA.querySelectorAll('input')[1].value;
          const inputB = rowB.querySelectorAll('input')[1].value;
          valA = inputA ? new Date(inputA + 'T00:00:00').getTime() : 0;
          valB = inputB ? new Date(inputB + 'T00:00:00').getTime() : 0;
        } else if (column === 'amount') {
          valA = parseFloat(rowA.querySelectorAll('input')[2].value) || 0;
          valB = parseFloat(rowB.querySelectorAll('input')[2].value) || 0;
        } else if (column === 'currentInstallment') {
          valA = parseInt(rowA.querySelectorAll('td')[5].textContent) || 0;
          valB = parseInt(rowB.querySelectorAll('td')[5].textContent) || 0;
        }

        if (currentSortDirection === 'asc') {
          return valA - valB;
        } else {
          return valB - valA;
        }
      });

      // Re-append rows in sorted order
      rows.forEach(row => tbody.appendChild(row));

      // Update header indicators
      document.querySelectorAll('th.sortable').forEach(th => {
        th.classList.remove('asc', 'desc');
      });
      const activeHeader = document.querySelector(`th.sortable[data-column="${column}"]`);
      if (activeHeader) {
        activeHeader.classList.add(currentSortDirection);
      }
    }

    // Add click listeners to sortable headers
    document.querySelectorAll('th.sortable').forEach(th => {
      th.addEventListener('click', () => {
        const column = th.getAttribute('data-column');
        sortTable(column);
      });
    });

    // ---- Storage (table only, no billing month) ----
    function readTableData() {
      const rows = document.querySelectorAll('#installmentsTable tbody tr');
      const data = [];
      rows.forEach((row) => {
        const inputs = row.querySelectorAll('input');
        if (inputs.length < 4) return;
        const merchant = inputs[0].value.trim();
        const enrollmentDate = inputs[1].value.trim();
        const amount = inputs[2].value.trim();
        const total = inputs[3].value.trim();
        if (!merchant && !enrollmentDate && !amount && !total) return;
        data.push({ merchant, enrollmentDate, amount, total });
      });
      return data;
    }

    function writeTableData(dataArray) {
      const tbody = document.querySelector('#installmentsTable tbody');
      tbody.innerHTML = '';
      dataArray.forEach((row) => addRow(row));
    }

    function saveTableToStorage() {
      try {
        const rowsData = readTableData();
        localStorage.setItem(STORAGE_KEY, JSON.stringify(rowsData));
        alert('Data saved locally ‚úî');
      } catch (err) {
        console.error('Error saving data:', err);
        alert('Error saving data (check console).');
      }
    }

    function loadTableFromStorage() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        const data = JSON.parse(raw);
        if (Array.isArray(data)) {
          writeTableData(data);
        }
      } catch (err) {
        console.error('Error loading data:', err);
      }
    }

    document.getElementById('saveDataBtn').addEventListener('click', saveTableToStorage);

    // ---- Core calculations ----

    // Ÿäÿ≠ÿ≥ÿ® First Installment / Current Installment / Remaining
    // ŸàŸäÿ±ÿ¨ÿπ Timeline (ŸÑŸà collectTimeline = true)
    function recomputeRowsAndCollectTimeline(billingDate, collectTimeline) {
      const rows = document.querySelectorAll('#installmentsTable tbody tr');
      const totalsByMonth = new Map();
      const detailsByMonth = new Map(); // Store detailed breakdown per month
      const merchantsByMonth = new Map(); // Store amounts by merchant per month

      rows.forEach((row) => {
        const cells = row.querySelectorAll('td');
        if (cells.length < 7) return;

        const merchantInput   = cells[0].querySelector('input');
        const enrollmentInput = cells[1].querySelector('input');
        const amountInput     = cells[2].querySelector('input');
        const totalInput      = cells[3].querySelector('input');
        const firstCell       = cells[4];
        const currentCell     = cells[5];
        const remainingCell   = cells[6];

        firstCell.textContent = '';
        currentCell.textContent = '';
        remainingCell.textContent = '';

        const merchantName = merchantInput.value.trim();
        const enrollmentVal = enrollmentInput.value;
        const amount = parseFloat(amountInput.value);
        const totalInst = parseInt(totalInput.value, 10);

        if (!enrollmentVal || isNaN(amount) || isNaN(totalInst) || totalInst <= 0) {
          return;
        }

        const enrollDate = new Date(enrollmentVal + 'T00:00:00');
        const day = enrollDate.getDate();

        // First billing month:
        // day <=22 ‚Üí ŸÜŸÅÿ≥ ÿ¥Ÿáÿ± ÿßŸÑŸÄ enrollment
        // day >22  ‚Üí ÿßŸÑÿ¥Ÿáÿ± ÿßŸÑŸÑŸä ÿ®ÿπÿØŸá
        const firstBillingMonth = new Date(
          enrollDate.getFullYear(),
          enrollDate.getMonth() + (day > 22 ? 1 : 0),
          1
        );

        // First installment date = 1 ŸÅŸä ÿßŸÑÿ¥Ÿáÿ± ÿßŸÑŸÑŸä ÿ®ÿπÿØ firstBillingMonth
        const firstInstallDate = addMonthsToDate(firstBillingMonth, 1);
        firstCell.textContent = formatDateYMD(firstInstallDate);

        // Current installment number ÿπŸÜÿØ billingMonth
        let currentInst = 0;
        let remaining = totalInst;

        if (billingDate >= firstBillingMonth) {
          const diffMonths =
            (billingDate.getFullYear() - firstBillingMonth.getFullYear()) * 12 +
            (billingDate.getMonth() - firstBillingMonth.getMonth());
          currentInst = Math.min(totalInst, diffMonths + 1);
          remaining = Math.max(0, totalInst - currentInst);
        }

        currentCell.textContent = currentInst.toString();
        remainingCell.textContent = remaining.toString();

        if (!collectTimeline || remaining <= 0) return;

        // Add all future payments (>= billingDate) ŸÑŸÑÿ™ÿßŸäŸÖŸÑÿßŸäŸÜ
        for (let k = 0; k < totalInst; k++) {
          const payDate = addMonthsToDate(firstInstallDate, k);
          if (payDate < billingDate) continue;

          const installmentNo = k + 1;
          const key = payDate.getFullYear() + '-' + String(payDate.getMonth() + 1).padStart(2, '0');

          if (totalsByMonth.has(key)) {
            totalsByMonth.get(key).total += amount;
          } else {
            totalsByMonth.set(key, { date: payDate, total: amount });
          }

          // Store detailed breakdown
          if (!detailsByMonth.has(key)) {
            detailsByMonth.set(key, []);
          }
          detailsByMonth.get(key).push({
            merchant: merchantName || 'N/A',
            installmentNo: installmentNo,
            amount: amount
          });

          // Store by merchant for stacked chart
          if (!merchantsByMonth.has(key)) {
            merchantsByMonth.set(key, new Map());
          }
          const monthMerchants = merchantsByMonth.get(key);
          if (monthMerchants.has(merchantName)) {
            monthMerchants.set(merchantName, monthMerchants.get(merchantName) + amount);
          } else {
            monthMerchants.set(merchantName, amount);
          }
        }
      });

      if (!collectTimeline) return { timeline: [], details: new Map(), merchants: new Map() };

      const sorted = Array.from(totalsByMonth.values()).sort((a, b) => a.date - b.date);
      return { timeline: sorted, details: detailsByMonth, merchants: merchantsByMonth };
    }

    let timelineChart = null;
    let currentTimelineDetails = new Map(); // Store details for click handling
    let currentMerchantsByMonth = new Map(); // Store merchant data for chart

    // Generate consistent colors for merchants
    const merchantColors = new Map();
    const colorPalette = [
      '#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6',
      '#ec4899', '#14b8a6', '#f97316', '#6366f1', '#84cc16',
      '#06b6d4', '#f43f5e', '#22c55e', '#eab308', '#a855f7'
    ];
    let colorIndex = 0;

    function getMerchantColor(merchant) {
      if (!merchantColors.has(merchant)) {
        merchantColors.set(merchant, colorPalette[colorIndex % colorPalette.length]);
        colorIndex++;
      }
      return merchantColors.get(merchant);
    }

    function calculateTimeline() {
      const billingMonthValue = document.getElementById('billingMonth').value;
      if (!billingMonthValue) {
        alert('Please select the billing month (statement month).');
        return;
      }
      const billingDate = new Date(billingMonthValue + '-01T00:00:00');

      const result = recomputeRowsAndCollectTimeline(billingDate, true);
      const timelinePairs = result.timeline;
      currentTimelineDetails = result.details;
      currentMerchantsByMonth = result.merchants;

      if (timelinePairs.length === 0) {
        alert('No installments found from this billing month onwards.');
        updateChart([], new Map(), []);
        hideMonthDetail();
        return;
      }

      const labels = timelinePairs.map(item => formatMonthLabel(item.date));

      // Get all unique merchants
      const allMerchants = new Set();
      currentMerchantsByMonth.forEach(monthData => {
        monthData.forEach((amount, merchant) => {
          allMerchants.add(merchant);
        });
      });

      updateChart(labels, currentMerchantsByMonth, timelinePairs);
      hideMonthDetail();
    }

    function updateChart(labels, merchantsByMonth, timelinePairs) {
      const ctx = document.getElementById('timelineChart').getContext('2d');

      // Get all unique merchants
      const allMerchants = new Set();
      merchantsByMonth.forEach(monthData => {
        monthData.forEach((amount, merchant) => {
          allMerchants.add(merchant);
        });
      });

      // Create datasets for each merchant
      const datasets = [];
      allMerchants.forEach(merchant => {
        const data = [];
        timelinePairs.forEach(item => {
          const key = item.date.getFullYear() + '-' + String(item.date.getMonth() + 1).padStart(2, '0');
          const monthData = merchantsByMonth.get(key);
          const amount = monthData && monthData.has(merchant) ? monthData.get(merchant) : 0;
          data.push(Number(amount.toFixed(2)));
        });

        datasets.push({
          label: merchant || 'N/A',
          data: data,
          backgroundColor: getMerchantColor(merchant),
          borderColor: getMerchantColor(merchant),
          borderWidth: 1
        });
      });

      if (timelineChart) {
        timelineChart.data.labels = labels;
        timelineChart.data.datasets = datasets;
        timelineChart.update();
        return;
      }

      timelineChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: datasets
        },
        options: {
          responsive: true,
          onClick: (event, activeElements) => {
            if (activeElements.length > 0) {
              const index = activeElements[0].index;
              const monthLabel = timelineChart.data.labels[index];
              showMonthDetail(monthLabel);
            }
          },
          plugins: {
            legend: {
              display: true,
              position: 'bottom',
              labels: {
                color: '#e5e7eb',
                padding: 10,
                font: {
                  size: 11
                }
              }
            },
            tooltip: {
              mode: 'index',
              intersect: false,
              callbacks: {
                label: function(context) {
                  const label = context.dataset.label || '';
                  const value = context.parsed.y;
                  // Only show non-zero values
                  if (value === 0) return null;
                  return label + ': ' + value.toFixed(2);
                },
                footer: function(tooltipItems) {
                  let total = 0;
                  tooltipItems.forEach(item => {
                    total += item.parsed.y;
                  });
                  return 'Total: ' + total.toFixed(2);
                }
              },
              filter: function(tooltipItem) {
                // Filter out zero values from tooltip
                return tooltipItem.parsed.y !== 0;
              }
            },
            datalabels: {
              display: true,
              color: '#ffffff',
              font: {
                weight: 'bold',
                size: 10
              },
              formatter: function(value, context) {
                // Only show label if value is not zero
                if (value === 0) return '';
                return value.toFixed(2);
              },
              anchor: 'center',
              align: 'center'
            }
          },
          scales: {
            x: {
              stacked: true,
              ticks: { color: '#e5e7eb' },
              grid: { color: '#374151' }
            },
            y: {
              stacked: true,
              ticks: { color: '#e5e7eb' },
              grid: { color: '#374151' }
            }
          }
        },
        plugins: [ChartDataLabels]
      });
    }

    function showMonthDetail(monthLabel) {
      // Parse the month label to get the key (YYYY-MM format)
      const billingMonthValue = document.getElementById('billingMonth').value;
      const billingDate = new Date(billingMonthValue + '-01T00:00:00');

      // Find the matching key in currentTimelineDetails
      let matchingKey = null;
      for (const [key, details] of currentTimelineDetails.entries()) {
        const keyDate = new Date(key + '-01T00:00:00');
        const keyLabel = formatMonthLabel(keyDate);
        if (keyLabel === monthLabel) {
          matchingKey = key;
          break;
        }
      }

      if (!matchingKey || !currentTimelineDetails.has(matchingKey)) {
        return;
      }

      const details = currentTimelineDetails.get(matchingKey);
      const tbody = document.querySelector('#monthDetailTable tbody');
      tbody.innerHTML = '';

      let totalAmount = 0;
      details.forEach((item) => {
        const tr = document.createElement('tr');
        const tdMerchant = document.createElement('td');
        const tdInstNo = document.createElement('td');
        const tdAmount = document.createElement('td');

        tdMerchant.textContent = item.merchant;
        tdInstNo.textContent = item.installmentNo;
        tdAmount.textContent = item.amount.toFixed(2);

        tr.appendChild(tdMerchant);
        tr.appendChild(tdInstNo);
        tr.appendChild(tdAmount);
        tbody.appendChild(tr);

        totalAmount += item.amount;
      });

      // Add total row
      const totalRow = document.createElement('tr');
      totalRow.style.fontWeight = 'bold';
      totalRow.style.borderTop = '2px solid #374151';
      const tdMerchantTotal = document.createElement('td');
      const tdInstNoTotal = document.createElement('td');
      const tdAmountTotal = document.createElement('td');
      tdMerchantTotal.textContent = 'Total';
      tdInstNoTotal.textContent = '';
      tdAmountTotal.textContent = totalAmount.toFixed(2);
      totalRow.appendChild(tdMerchantTotal);
      totalRow.appendChild(tdInstNoTotal);
      totalRow.appendChild(tdAmountTotal);
      tbody.appendChild(totalRow);

      document.getElementById('monthDetailTitle').textContent = `Installments for ${monthLabel}`;
      document.getElementById('monthDetailSection').style.display = 'block';
    }

    function hideMonthDetail() {
      document.getElementById('monthDetailSection').style.display = 'none';
    }

    document.getElementById('calculateBtn').addEventListener('click', calculateTimeline);

    // ŸÑŸÖÿß ÿßŸÑŸÄ Billing month Ÿäÿ™ÿ∫Ÿäÿ±ÿå ŸÜÿπŸäÿØ ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ£ÿπŸÖÿØÿ© ÿßŸÑŸÖÿ¥ÿ™ŸÇÿ© (ŸÖŸÜ ÿ∫Ÿäÿ± ÿ±ÿ≥ŸÖ ÿßŸÑÿ¨ÿ±ÿßŸÅ)
    document.getElementById('billingMonth').addEventListener('change', () => {
      const val = document.getElementById('billingMonth').value;
      if (!val) return;
      const billingDate = new Date(val + '-01T00:00:00');
      recomputeRowsAndCollectTimeline(billingDate, false);
    });

    // Increase/Decrease billing month buttons
    document.getElementById('increaseMonthBtn').addEventListener('click', () => {
      const input = document.getElementById('billingMonth');
      if (!input.value) return;
      const currentDate = new Date(input.value + '-01T00:00:00');
      const newDate = addMonthsToDate(currentDate, 1);
      const year = newDate.getFullYear();
      const month = String(newDate.getMonth() + 1).padStart(2, '0');
      input.value = `${year}-${month}`;
      input.dispatchEvent(new Event('change'));
    });

    document.getElementById('decreaseMonthBtn').addEventListener('click', () => {
      const input = document.getElementById('billingMonth');
      if (!input.value) return;
      const currentDate = new Date(input.value + '-01T00:00:00');
      const newDate = addMonthsToDate(currentDate, -1);
      const year = newDate.getFullYear();
      const month = String(newDate.getMonth() + 1).padStart(2, '0');
      input.value = `${year}-${month}`;
      input.dispatchEvent(new Event('change'));
    });

    // init: Billing month = ÿßŸÑÿ¥Ÿáÿ± ÿßŸÑÿ≠ÿßŸÑŸä + ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ¨ÿØŸàŸÑ ŸÖŸÜ ÿßŸÑÿ™ÿÆÿ≤ŸäŸÜ + ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ£ÿπŸÖÿØÿ©
    (function init() {
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      document.getElementById('billingMonth').value = `${year}-${month}`;

      loadTableFromStorage(); // ŸÑŸà ŸÅŸäŸá ÿØÿßÿ™ÿß ŸÖÿ≠ŸÅŸàÿ∏ÿ© Ÿáÿ™ŸÉÿ™ÿ® ŸÖŸÉÿßŸÜ ÿßŸÑŸÄ sample rows

      // Setup all date inputs to show dd/mm/yyyy format
      const allDateInputs = document.querySelectorAll('input[type="date"]');
      allDateInputs.forEach(input => {
        setupDateInput(input);
      });

      // Add event listeners to existing rows for auto-recalculation
      const existingAutoRecalcInputs = document.querySelectorAll('#installmentsTable .auto-recalc');
      existingAutoRecalcInputs.forEach(input => {
        input.addEventListener('change', triggerRecalculation);
      });

      const billingDate = new Date(`${year}-${month}-01T00:00:00`);
      recomputeRowsAndCollectTimeline(billingDate, false);
    })();
  </script>
</body>
</html>
